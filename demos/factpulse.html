<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FactPulse Pro — Demo</title>
<style>
  :root{
    --bg:#0b0e13; --card:#111317; --line:#1b1e25;
    --text:#e6e9ef; --muted:#9aa3b2; --accent:#16c1b8; --badge:#25323a;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:40px auto;padding:0 16px}
  h1,h2{margin:0 0 12px} .muted{color:var(--muted)}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin:14px 0}
  input,button,textarea,select{background:#0f131a;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:10px 12px;font:inherit}
  button{cursor:pointer} .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1} .badge{display:inline-block;background:var(--badge);padding:2px 8px;border-radius:999px}
  .small{font-size:12px}
</style>
<div class="wrap">
  <h1>FactPulse Pro <span class="badge">demo</span></h1>
  <p class="muted">Heuristic scoring (not a fact-check). We show a risk score, two signals, two actions, and starter sources. Recent entries appear below.</p>

  <div class="card">
    <div class="row">
      <input id="t" placeholder="Paste a post or headline…" autocomplete="off" />
      <button id="go">Score</button>
    </div>
    <div id="result" class="small" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h2 style="margin-bottom:8px">Recent stream</h2>
    <div id="stream" class="small muted">Loading…</div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);

// small helpers
function uniq2(pool, r1, r2){ // ensure two distinct picks
  const a = pool[Math.floor(r1*pool.length)];
  let b = pool[Math.floor(r2*pool.length)];
  if(b===a) b = pool[(Math.floor(r2*pool.length)+1)%pool.length];
  return [a,b];
}

async function score(text){
  try{
    const r = await fetch('/.netlify/functions/score',{
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({text})
    });
    if(!r.ok) throw new Error('scoring service unavailable');
    const p = await r.json();
    // guard for older handler variants
    const signals = [...new Set(p.signals||[])].slice(0,2);
    const actions = [...new Set(p.actions||[])].slice(0,2);
    const sources = (p.sources||[]).slice(0,2);
    return { score:p.score||0.35, signals, actions, sources };
  }catch(e){
    // local fallback (still varied & unique)
    const signalsPool=['no-source-citation','low-source-cred','coordinated-amplification','misleading-caption','out-of-context-clip','synthetic-media-indicators','delegitimizing-language'];
    const actionsPool=['monitor','link-to-official','prepare-FAQ','platform escalation','legal review','internal flag','takedown request'];
    const h = [...(text||'')].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0)|0,0);
    const r1 = Math.abs(Math.sin(h%97));
    const r2 = Math.abs(Math.sin((h+17)%97));
    const [sA,sB] = uniq2(signalsPool,r1,r2);
    const [aA,aB] = uniq2(actionsPool,r2,r1);
    const sources=[{name:'EU DisinfoLab',url:'https://www.disinfo.eu'},{name:'AP News',url:'https://apnews.com'}];
    return { score: Math.min(0.9, Math.max(0.1, 0.34 + (r1*0.5))), signals:[sA,sB], actions:[aA,aB], sources };
  }
}

async function logFact({text,score,signals,actions}){
  // best-effort; ignore failure
  fetch('/.netlify/functions/record_fact', {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({text,score,signals,actions})
  }).catch(()=>{});
}

async function loadStream(){
  // try live DB list, else sample JSON
  try{
    const r = await fetch('/.netlify/functions/list_facts?v='+Date.now());
    if(!r.ok) throw 0;
    const {facts=[]} = await r.json();
    if(!facts.length) throw 0;
    $('#stream').innerHTML = facts.map(s=>card(s.text, s.score, s.signals, s.actions)).join('');
    return;
  }catch{}
  // fallback to samples
  try{
    const s = await (await fetch('/data/factpulse.json?v='+Date.now())).json();
    $('#stream').innerHTML = s.samples.map(x=>card(x.text, x.score, x.signals, x.actions)).join('');
  }catch{
    $('#stream').textContent = 'No recent items.';
  }
}

function card(text, score, signals=[], actions=[]){
  return `<div class="card" style="margin:8px 0">
    <b>${escapeHtml(text)}</b><br>
    Risk score: ${(score*100|0)}%<br>
    Signals: ${[...new Set(signals)].join(', ')}<br>
    Actions: ${[...new Set(actions)].join(', ')}
  </div>`;
}

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

$('#go').onclick = async ()=>{
  const t = $('#t').value.trim();
  if(!t){ $('#result').textContent = 'Please paste text to score.'; return; }
  $('#result').textContent = 'Scoring…';
  const p = await score(t);
  $('#result').innerHTML =
    `<b>${escapeHtml(t)}</b><br>
     Risk score: ${(p.score*100|0)}%<br>
     Signals: ${p.signals.join(', ')}<br>
     Actions: ${p.actions.join(', ')}<br>
     Sources: ${(p.sources||[]).map(s=>`<a href="${s.url}" target="_blank" rel="noopener">${s.name}</a>`).join(' · ')}
     <div class="small muted" style="margin-top:6px">Heuristic demo only — not a fact-check.</div>`;
  logFact({text:t,score:p.score,signals:p.signals,actions:p.actions});
  loadStream(); // refresh list so this shows up when backend is active
};

loadStream();
</script>
</html>

<!doctype html><html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Field Triage Dashboard — ETHRAEON</title><link rel="stylesheet" href="/assets/brand.css">
<body><div class="container">
  <div class="hero"><div class="logo"></div><div><h1>Field Triage Dashboard</h1>
    <div class="small">Intake → classify → safe actions. Governance baked in.</div></div></div>

  <div class="card"><div class="badge">LIVE</div>
    <h2>Log a case (10 seconds)</h2>
    <div class="small">Pick a category and write one sentence. Leave Case ID blank to auto-generate.</div>
    <form id="f">
      <label>Category</label><br/>
      <select id="category" required>
        <option value="Harassment">Harassment</option>
        <option value="Self-harm">Self-harm</option>
        <option value="Data leak">Data leak</option>
        <option value="Brand safety">Brand safety</option>
      </select><br/><br/>
      <label>Case ID (optional)</label><br/>
      <input id="caseId" placeholder="Leave blank to auto-generate"><br/><br/>
      <label>Summary</label><br/>
      <input id="summary" placeholder="One sentence" required style="width:100%"><br/><br/>
      <button id="submitBtn">Submit</button>
      <span id="msg" class="small" style="margin-left:8px"></span>
    </form>
  </div>

  <h2 style="margin-top:16px">Recent cases (live)</h2>
  <div id="recent" class="small">Loading…</div>

  <p class="small">Status: Writes to Neon DB and lists latest 25.</p>
</div>

<div class="card">
<h2 style="margin-top:16px">Recent cases (live)</h2>
<div id="recent" class="small">Loading…</div>
<script>
async function loadRecent(){
  const r = await fetch('/.netlify/functions/list_cases');
  const d = await r.json().catch(()=>({cases:[]}));
  const html = (d.cases||[]).map(c=>`<div class="card" style="margin:8px 0">
    <b>${c.case_id}</b> — ${c.summary}<br><span class="muted">${new Date(c.created_at).toLocaleString()}</span>
  </div>`).join('') || 'No cases yet.';
  document.querySelector('#recent').innerHTML = html;
}
loadRecent();
</div>

<script src="/assets/demo.js"></script>
<script>
function el(s){return document.querySelector(s)}
async function loadRecent(){
  try {
    const r = await fetch('/.netlify/functions/list_cases');
    const d = await r.json();
    el('#recent').innerHTML = (d.cases||[]).map(c=>`
      <div class="card" style="margin:8px 0">
        <b>${c.case_id}</b> — <i>${c.category||'—'}</i><br>${c.summary}<br>
        <span class="muted">${new Date(c.created_at).toLocaleString()}</span>
      </div>`).join('') || 'No cases yet.';
  } catch { el('#recent').textContent = 'Unable to load cases.'; }
}
loadRecent();

el('#f').onsubmit = async (e)=>{
  e.preventDefault();
  el('#msg').textContent = 'Submitting…';
  const caseId = el('#caseId').value || (()=>{ 
  if (window.crypto && window.crypto.getRandomValues) {
    const a = new Uint32Array(1); window.crypto.getRandomValues(a);
    return 'INC-' + a[0].toString(16).toUpperCase().padStart(6,'0').slice(0,6);
  }
  return 'INC-' + Math.random().toString(36).slice(2,8).toUpperCase();
})();
  const payload = { caseId, summary: el('#summary').value, category: el('#category').value };
  try{
    const r = await fetch('/.netlify/functions/submit_case', {
      method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error(await r.text()) }
    el('#msg').textContent = 'Saved.';
    el('#summary').value = ''; el('#caseId').value = '';
    await loadRecent();
  }catch(err){
    el('#msg').textContent = 'Error saving.';
  }
};
</script>
</body></html>

<!doctype html><html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="../assets/brand.css">
<title>Field Triage Dashboard</title>
<body>
<div class="wrap">
  <h1><span class="dot"></span> Field Triage Dashboard</h1>
  <p class="sub">Intake → classify → governed actions. Governance baked in.</p>

  <div class="card">
    <span class="badge">LIVE</span>
    <h2>Log a case (10 seconds)</h2>
    <form id="f">
      <label>Category</label>
      <select id="category">
        <option>Harassment</option>
        <option>Threats</option>
        <option>Hate</option>
        <option>Self-harm</option>
        <option>Data leak</option>
        <option>Violence</option>
        <option>Other</option>
      </select>
      <label>Case ID (optional)</label>
      <input id="caseId" placeholder="Leave blank to auto-generate">
      <label>Summary</label>
      <input id="summary" placeholder="One sentence">
      <button type="submit">Submit</button>
      <span id="msg" class="small" style="margin-left:8px"></span>
    </form>
  </div>

  <div class="card">
    <h2>Recent cases (live)</h2>
    <div id="recent" class="small">Loading…</div>
    <div class="small" style="opacity:.75;margin-top:6px">Status: Writes to Neon DB and lists latest 25.</div>
  </div>
</div>

<script>
const el = s=>document.querySelector(s);

// severity model (weighted)
function sevColor(sev){ if(sev>=4) return '#ff5555'; if(sev>=3) return '#ffcc00'; return '#33cc99'; }
function scoreSeverity(cat, summary){
  let sev = 1, s = (summary||'').toLowerCase();
  const catBoost = {'Self-harm':5,'Threats':4,'Harassment':3,'Data leak':5,'Violence':5,'Hate':4};
  if (catBoost[cat]) sev = Math.max(sev, catBoost[cat]);
  const bumps = [
    {re:/ssn|social security|pii|data leak|breach|password|credential|dox/i, sev:5},
    {re:/suicide|self[- ]?harm|kill myself|harm myself/i, sev:5},
    {re:/bomb|shoot|threat/i, sev:4},
    {re:/sexual assault|assault|inappropriately touched|harassment/i, sev:4},
    {re:/illegal|how to (?:make|do|bypass)|instructions to/i, sev:4}
  ];
  bumps.forEach(b=>{ if(b.re.test(s)) sev = Math.max(sev, b.sev); });
  return Math.min(5, Math.max(1, sev));
}
function actionsFor(cat, sev){
  if(sev>=5) return ['Escalate to Security', 'Notify Legal', 'Suspend access'];
  if(sev>=4) return ['Manager review', 'Open incident', 'Safety check'];
  if(sev>=3) return ['Acknowledge & monitor', 'Offer support', 'HR review'];
  return ['Acknowledge & monitor'];
}
function linksFor(cat){
  const L={ "Self-harm":[{t:'988 Lifeline',u:'https://988lifeline.org/'}],
            "Data leak":[{t:'US-CERT',u:'https://www.cisa.gov/report'}],
            "Threats":[{t:'FBI Tips',u:'https://tips.fbi.gov/'}] };
  return L[cat]||[];
}

function renderErr(msg){
  el('#recent').innerHTML = `<div class='small' style='color:#ff6'>${msg}</div>`;
}
function renderList(cases){
  el('#recent').innerHTML = (cases||[]).map(c=>{
    const sev = scoreSeverity(c.category, c.summary);
    const acts = actionsFor(c.category, sev);
    const links = linksFor(c.category||'');
    return `<div class="card" style="margin:8px 0">
      <b>${c.case_id}</b> — <span class="badge" style="background:${sevColor(sev)};color:#000">Severity ${sev}/5</span><br>
      <i>${c.category||'Uncategorized'}</i> — ${c.summary}<br>
      <b>Recommended:</b> ${acts.join(' · ')}<br>
      ${(links.length?('<b>Refs:</b> '+links.map(x=>`<a target="_blank" rel="noopener" href="${x.u}">${x.t}</a>`).join(' · ')):'')}
      <div class="small" style="opacity:.8">Logged: ${new Date(c.created_at).toLocaleString()}</div>
    </div>`;
  }).join('') || '<div class="small">No recent cases.</div>';
}

async function loadRecent(){
  try{
    const r = await fetch('/.netlify/functions/list_cases?v=' + Date.now());
    if(!r.ok) throw new Error(await r.text());
    const j = await r.json();
    renderList(j.cases||[]);
  }catch(e){ renderErr('Unable to load recent: ' + (e&&e.message||e)); }
}

// submit
el('#f').onsubmit = async (e)=>{
  e.preventDefault();
  el('#msg').textContent = 'Submitting…';
  const caseId = el('#caseId').value || (()=>{ const a=new Uint32Array(1); (crypto||window.crypto).getRandomValues(a); return 'INC-'+a[0].toString(16).toUpperCase().slice(0,6); })();
  const payload = { caseId, summary: el('#summary').value, category: el('#category').value };
  try{
    const r = await fetch('/.netlify/functions/submit_case', {
      method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error(await r.text());
    el('#msg').textContent = 'Saved.';
    el('#summary').value = ''; el('#caseId').value = '';
    loadRecent();
  }catch(err){
    el('#msg').textContent = 'Error: ' + (err&&err.message||err);
  }
};

// initial load
loadRecent();
</script>
</body></html>
